# OrderHistory Agent Guide

This documentation helps agents and developers understand and work with the OrderHistory codebase.

## Project Overview
OrderHistory is a self-hosted tool to track online purchases from various platforms (Amazon, eBay, AliExpress, Alternate). It consists of:
1.  **Backend**: Go (Gin) server with SQLite.
2.  **Frontend**: React (Vite) web UI to view and manage orders.
3.  **Client**: Tampermonkey user scripts that run on vendor websites to scrape and upload order data.

## Tech Stack
-   **Backend**: Go 1.19, Gin Web Framework, SQLite3.
-   **Frontend**: React 18, Vite.
-   **Database**: SQLite.
-   **Client**: JavaScript (Tampermonkey userscripts).

## Code Structure
-   `/`: Go backend root (`main.go`, `go.mod`).
-   `/ui_api`: Go package for UI-related API logic.
-   `/reqHandler`: Go package for handling HTTP requests.
-   `/db`: Go package for database interactions.
-   `/struct`: Go data structures/models.
-   `/reactFrontend`: React Vite project source.
-   `/client/tampermonkey`: User scripts for different vendors.
-   `/img`: Storage for downloaded product images.
-   `/sql`: SQL helper scripts.

## Setup & Running

### 1. Database Configuration (CRITICAL)
**Gotcha**: The database path is **hardcoded** in `main.go`.
-   Open `main.go` and check the `sql.Open` call in `main()`.
-   Ensure the path points to a valid SQLite database file (e.g., one from `db_backup/` or a new one).
-   Current default: `/mnt/d/20230702_orderHistory-sqlite.db`

### 2. Backend (Go)
To run the server:
```bash
go run main.go
```
-   Runs on **Port 8081**.
-   Serves API at `http://localhost:8081`.
-   Serves frontend at `http://localhost:8081/webui` (requires build).
-   Serves images at `http://localhost:8081/img`.

### 3. Frontend (React)
The frontend is a Vite app located in `reactFrontend/`.

To develop:
```bash
cd reactFrontend
npm install
npm run dev
```

To build for production (required for Go server embedding):
```bash
cd reactFrontend
npm run build
```
The Go server embeds the `dist` folder generated by this command.

### 4. Client (Tampermonkey)
Scripts in `client/tampermonkey/` are meant to be installed in the Tampermonkey browser extension.
-   They inject "Upload" buttons into order history pages (e.g., Amazon Orders).
-   They communicate with `http://localhost:8081` (hardcoded in scripts).

## API Endpoints
-   `GET /allitems`: List orders (supports pagination: `?page=1&limit=50`).
-   `POST /order/:platform`: Add order from script (`:platform` = `amazon`, `ebay`, `aliexpress`, `alternate`).
-   `POST /newItemManual`: Add single item manually.
-   `POST /imageUpload`: Upload/update item image.
-   `GET /checkItemExists`: Check duplication before upload.

## Common Tasks

### Adding a new Platform
1.  Create `struct/<platform>.go` struct.
2.  Create `db/<platform>.go` database logic.
3.  Create `reqHandler/<platform>.go` request handler.
4.  Register handler in `main.go` inside the `POST /order/:platform` block.
5.  Create Tampermonkey script in `client/tampermonkey/`.

### Updating the Frontend
1.  Modify code in `reactFrontend/src`.
2.  Run `npm run build` in `reactFrontend/`.
3.  Restart Go server to serve new assets.

## Important Notes
-   **Images**: Stored locally in `/img`. The server serves this directory statically.
-   **Database Path**: Always check `main.go` if DB connection fails.
-   **CORS**: Enabled for all origins in `main.go` (`r.Use(cors.AllowAll())`).
